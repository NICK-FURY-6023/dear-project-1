{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Found Items</title>
    <link rel="stylesheet" href="{% static 'css/view_found.css' %}">
    <script src="{% static 'js/view_found.js' %}" defer></script>
</head>
<body>

    <header>
        <h1>Lost & Found Portal</h1>
        <nav>
            <a href="{% url 'home' %}">Home</a>
            <a href="{% url 'report_found' %}">Report Found Item</a>
            <a href="{% url 'view_found' %}" class="active">View Found Items</a>
            {% if user.is_authenticated %}
                <a href="{% url 'my_found_items' %}">My Items</a>
                <a href="{% url 'logout' %}">Logout</a>
            {% else %}
                <a href="{% url 'login' %}">Login</a>
            {% endif %}
        </nav>
    </header>

    <main>
        <section class="items-list">
            <h2>Recently Found Items</h2>
            <p>Browse the list of items reported as found.</p>

            {% if items %}
                <div class="items-container">
                    {% for item in items %}
                        <div class="item-card">
                            {% if item.image %}
                                <img src="{{ item.image.url }}" alt="Item Image" class="item-image">
                            {% else %}
                                <img src="{% static 'images/no-image.svg' %}" alt="No Image" class="item-image">
                            {% endif %}
                            
                            <div class="item-details">
                                <h3>{{ item.item_name }}</h3>
                                <p><strong>Description:</strong> {{ item.description }}</p>
                                <p><strong>Category:</strong> {{ item.get_category_display }}</p>
                                <p><strong>Location Found:</strong> {{ item.location }}</p>
                                <p><strong>Date Found:</strong> {{ item.date_found }}</p>
                                <p><strong>Reported By:</strong> {{ item.user.username }}</p>

                                <button onclick="openChat('{{ item.user.username }}')">
                                    Chat with Founder
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-items">No found items available at the moment.</p>
            {% endif %}
        </section>
    </main>

    <!-- Chat Box -->
    <div id="chat-box" class="chat-box" style="display: none;">
        <div class="chat-header">
            <span id="chat-user-name"></span>
            <button onclick="closeChat()">❌</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        let ws = null; // ✅ Declare WebSocket globally

        
function openChat(username) {
    document.getElementById("chat-user-name").textContent = `Chat with ${username}`;
    document.getElementById("chat-box").style.display = "block";

    // ✅ Close existing WebSocket if already open
    if (ws) {
        ws.close();
    }

    ws = new WebSocket(`ws://127.0.0.1:8000/ws/chat/${username}/`);

    ws.onopen = function () {
        console.log("✅ WebSocket connection established.");
    };

    ws.onmessage = function (event) {
        let data = JSON.parse(event.data);
        let chatMessages = document.getElementById("chat-messages");
        let messageElement = document.createElement("p");
        messageElement.textContent = `${data.username}: ${data.text}`;
        chatMessages.appendChild(messageElement);
    };

    ws.onclose = function () {
        console.log("❌ WebSocket connection closed.");
    };

    ws.onerror = function (error) {
        console.error("⚠️ WebSocket error:", error);
    };
}

function sendMessage() {
    let messageInput = document.getElementById("chat-input");
    let messageText = messageInput.value.trim();

    if (messageText !== "" && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ message: messageText }));
        messageInput.value = "";
    } else {
        console.warn("⚠️ WebSocket is not connected.");
    }
}

function closeChat() {
    document.getElementById("chat-box").style.display = "none";
    if (ws) {
        ws.close();
    }
}

    </script>
    
</body>
</html>
