{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <title>My Found Items</title>
    <link rel="stylesheet" href="{% static 'css/my_found_items.css' %}">
    <script defer src="{% static 'js/my_found_items.js' %}"></script>
</head>
<body>

    <!-- HEADER SECTION -->
    <header>
        <div class="logo">Lost & Found Portal</div>
        <nav class="links">
            <a href="{% url 'home' %}">Home</a>
            <a href="{% url 'report_found' %}">Report Found</a>
            <a href="{% url 'view_found' %}">View Found</a>
            <a href="{% url 'my_found_items' %}" class="active">My Items</a>
            <a href="{% url 'logout' %}" onclick="return confirmLogout();">Logout</a>
        </nav>
    </header>

    <!-- MY FOUND ITEMS SECTION -->
    <section class="my-items">
        <h2>üì¶ My Found Items</h2>
        <div class="items-container">
            {% for item in found_items %}
            <div class="item-card" id="item-{{ item.id }}">
                {% if item.image %}
                <img src="{{ item.image.url }}" alt="{{ item.item_name }}">
                {% endif %}
                <p><strong>Item:</strong> {{ item.item_name }}</p>
                <p><strong>Location:</strong> {{ item.location }}</p>
                <p><strong>Found On:</strong> {{ item.date_found }}</p>
                <div class="card-actions">
                    <button class="edit-btn" onclick="editItem({{ item.id }})">‚úè Edit</button>
                    <button class="delete-btn" onclick="deleteItem({{ item.id }})">üóë Delete</button>
                    <button class="claimed-btn" onclick="markClaimed({{ item.id }})">‚úÖ Mark as Claimed</button>
                    <button class="response-btn" onclick="openResponseList({{ item.id }})">üí¨ Responses</button>
                </div>

                <!-- Response list for each item -->
                <div class="response-list" id="response-list-{{ item.id }}" style="display: none;">
                    <h3>Select a user to chat:</h3>
                    <ul>
                        {% for response in item.responses.all %}
                        <li onclick="openChat('{{ response.user.username }}')">
                            {{ response.user.username }}
                        </li>
                        {% empty %}
                        <li>No responses yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% empty %}
            <p>No found items reported yet.</p>
            {% endfor %}
        </div>
    </section>

    <!-- CHAT BOX -->
    <div id="chat-box" class="chat-box">
        <div class="chat-header">
            <span id="chat-user-name"></span>
            <button onclick="closeChat()">‚ùå</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>

    <footer>
        <p>&copy; 2025 Lost & Found Portal</p>
    </footer>

<script>
    function confirmLogout() {
        return confirm("Are you sure you want to log out?");
    }

    // Function to toggle the response list visibility
    function openResponseList(itemId) {
        let responseList = document.getElementById(`response-list-${itemId}`);
        if (responseList.style.display === "none" || responseList.style.display === "") {
            responseList.style.display = "block";
        } else {
            responseList.style.display = "none";
        }
    }

    // Open Chat Function
    function openChat(username) {
        document.getElementById("chat-user-name").textContent = `Chat with ${username}`;
        document.getElementById("chat-box").style.display = "block";

        fetch(`/chat/${username}/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById("chat-messages").innerHTML = html;
            })
            .catch(error => {
                document.getElementById("chat-messages").innerHTML = `<p>Error loading chat.</p>`;
            });
    }

    // Close Chat Box
    function closeChat() {
        document.getElementById("chat-box").style.display = "none";
    }

    // Send Message Function
    function sendMessage() {
        let messageInput = document.getElementById("chat-input");
        let messageText = messageInput.value.trim();
        if (messageText !== "") {
            let chatMessages = document.getElementById("chat-messages");
            let messageElement = document.createElement("p");
            messageElement.textContent = `You: ${messageText}`;
            chatMessages.appendChild(messageElement);
            messageInput.value = "";

            fetch(window.location.pathname, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type":  "{{ csrf_token }}" 
                },
                body: JSON.stringify({ message: messageText })
            });
        }
    }
    function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

</script>

</body>
</html>
